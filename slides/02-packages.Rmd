---
title: "Data Science with R"
subtitle: "Lecture 02: R packages"
author: "Christine Choirat, cchoirat@gmail.com"
date: "October 26, 2015"
output: ioslides_presentation
---

# R packages

## Why?

## Structure

- Folder hierarchy
    - `NAMESPACE`
    - `DESCRIPTION`
    - `R/`
    - `man/`
    - `tests/`
    - `data/`
    - `src/`
    - `vignettes/`
    - `inst/`

## Building steps

## Creating an R package

### `utils::package.skeleton`

```{r eval=FALSE}
package.skeleton() # "in "fresh" session ("anRpackage")
package.skeleton("pkgname") # in "fresh" session

set.seed(02138)
f <- function(x, y) x+y
g <- function(x, y) x-y
d <- data.frame(a = 1, b = 2)
e <- rnorm(1000)
package.skeleton(list = c("f","g","d","e"), name = "pkgname")
```

### `devtools::create`

```{r eval=FALSE}
devtools::create("path/to/package/pkgname")
```

## Using GitHub

<iframe src="http://r-pkgs.had.co.nz/git.html"></iframe>

## RStudio and GitHub integration (1 / 7)

<div class="centered">
<img src="02_packages/create_git_package_1.png" width="600px"/>
</div>

## RStudio and GitHub integration (2 / 7)

<div class="centered">
<img src="02_packages/create_git_package_2.png" width="600px"/>
</div>

## RStudio and GitHub integration (3 / 7)

<div class="centered">
<img src="02_packages/create_git_package_3.png" width="600px"/>
</div>

## RStudio and GitHub integration (4 / 7)

<div class="centered">
<img src="02_packages/create_git_package_4.png" width="600px"/>
</div>

## RStudio and GitHub integration (5 / 7)

<div class="centered">
<img src="02_packages/create_git_package_5.png" width="600px"/>
</div>

## Command line

```{r eval=FALSE}
git init
git add *
git commit -m "First commit"
git remote add origin git@github.com:harvard-P01/pkgtemplate.git
git push -u origin master
```

## RStudio and GitHub integration (6 / 7)

<div class="centered">
<img src="02_packages/create_git_package_6.png" width="600px"/>
</div>

## RStudio and GitHub integration (7 / 7)

<div class="centered">
<img src="02_packages/create_git_package_7.png" width="600px"/>
</div>

## Installing from GitHub

```{r eval=FALSE}
devtools::install_github("harvard-P01/pkgtemplate")
```

## `.gitignore` (RStudio default)

```{r eval=FALSE}
.Rproj.user
.Rhistory
.RData
```

## `.gitignore` (GitHub default)

```{r eval=FALSE}
# History files
.Rhistory
.Rapp.history

# Example code in package build process
*-Ex.R

# RStudio files
.Rproj.user/

# produced vignettes
vignettes/*.html
vignettes/*.pdf
```

## RStudio projects

- `.Rproj` file extension, in our example `pkgtemplate.Rproj`

- A project has its own:
    - R session
    - .Rprofile (_e.g._, to customize startup environement)
    - .Rhistory

- Default working directory is project directory

- Keeps track of project-specific recent files

## Project options

```{r eval=FALSE}
Version: 1.0

RestoreWorkspace: Default
SaveWorkspace: Default
AlwaysSaveHistory: Default

EnableCodeIndexing: Yes
UseSpacesForTab: Yes
NumSpacesForTab: 2
Encoding: UTF-8

RnwWeave: knitr
LaTeX: pdfLaTeX

AutoAppendNewline: Yes
StripTrailingWhitespace: Yes

BuildType: Package
PackageUseDevtools: Yes
PackageInstallArgs: --no-multiarch --with-keep.source
```

## Package documentation

- Functions and methods

- Vignettes
    - PDF
    - `knitr`, `Sweave`

## Adding R code

- In `R/` directory

- File `linreg.R`

```{r eval=FALSE}
linreg <- function(y, X) {
  X <- cbind(1, X) # add intercept
  beta_hat <- solve(t(X) %*% X) %*% t(X) %*% y
  return(beta_hat)
}
```

## Adding ROxygen2 documentation

```{r eval=FALSE}
#' Linear regression
#'
#' Runs an OLS regression not unlike \code{\link{lm}}
#'
#' @param y response vector (1 x n)
#' @param X covariate matrix (p x n) with no intercept
#'
#' @return A (p x 1) matrix of estimated parameters
#'
#' @examples
#' data(mtcars)
#' X <- as.matrix(mtcars[, c("cyl", "disp", "hp")])
#' y <- mtcars[, "mpg"]
#' linreg(y, X)
#'
#' @export
#'
linreg <- function(y, X) {
  X <- cbind(1, X) # add intercept
  beta_hat <- solve(t(X) %*% X) %*% t(X) %*% y
  return(beta_hat)
}
```

## Configure Build Tools

<div class="centered">
<img src="02_packages/configure_build_tools.png" width="400px"/>
</div>

## `man/linreg.Rd`

```{r eval=FALSE}
\name{linreg}
\alias{linreg}
\title{Linear regression}
\usage{
linreg(y, X)
}
\arguments{
\item{y}{response vector (1 x n)}

\item{X}{covariate matrix (p x n) with no intercept}
}
\value{
A (p x 1) matrix of estimated parameters
}
\description{
Runs an OLS regression not unlike \code{\link{lm}}
}
\examples{
data(mtcars)
X <- as.matrix(mtcars[, c("cyl", "disp", "hp")])
y <- mtcars[, "mpg"]
linreg(y, X)
}
```

## Formatted output

<div class="centered">
<img src="02_packages/formatted_help.png" width="400px"/>
</div>


## `DESCRIPTION`

```{r eval=FALSE}
Package: pkgtemplate
Type: Package
Title: What the Package Does (Title Case)
Version: 0.1
Date: 2015-10-24
Author: Who wrote it
Maintainer: Who to complain to <yourfault@somewhere.net>
Description: More about what it does (maybe more than one line)
License: What license is it under?
LazyData: TRUE
```

## `NAMESPACE`

```{r eval=FALSE}
export(linreg)
```

## S3 and S4 generics

## Workflow

- devtools
- ROxygen2

## Unit tests and `testthat`

## Makefiles and `make`

## Freezing package repositories

- https://rstudio.github.io/packrat/

- MCRAN (???)

- Docker

# [Rcpp](http://www.rcpp.org/)

## C/C++ ressources

## C++

- C++ and Rcpp (direct interchange of R objects between R and C++): http://www.rcpp.org/.  Installation: platforms are not created equal
- Linux: enjoy your package manager!
- OS X
    - install Xcode from Apple
    - install the Command Line Tools
    - `install.packages("Rcpp"); install.packages("inline")`
- Windows
    - install Rtools: https://cran.rstudio.com/bin/windows/Rtools/
    - `install.packages("Rcpp"); install.packages("inline")`

## The inevitable rabbits

R does not handle recursive functions very well:

```{r}
fibo <- function(n) {
  if (n == 0)
    return(0)
  if (n == 1)
    return(1)
  return(fibo(n - 1) + fibo(n - 2))
}
```

```{r eval=FALSE}
system.time(fibo(35))
```

`fibo(35)` takes 25 seconds on my machine...

## C++ is __faster__

```{r}
library(Rcpp)
fibRcpp <- cppFunction( '
int fibo(const int n) {
   if (n == 0)
      return(0);
   if (n == 1)
      return(1);
   return (fibo(n - 1)) + fibo(n - 2);
}
' )
```

## C++ is __faster__

```{r}
fibRcpp
```

Performance is much better:

```{r}
system.time(print(fibRcpp(35)))
```

## `Rcpp` family

`RcppArmadillo`

> 'Armadillo' is a templated C++ linear algebra library (by Conrad Sanderson) that aims towards a good balance between speed and ease of use. Integer, floating point and complex numbers are supported, as well as a subset of trigonometric and statistics functions. Various matrix decompositions are provided through optional integration with LAPACK and ATLAS libraries. The 'RcppArmadillo' package includes the header files from the templated 'Armadillo' library.
