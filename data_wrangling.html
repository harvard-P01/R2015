<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>P01 - Data wrangling</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/default.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<style type="text/css">
  body {
    padding-top: 20px;
  }
  .navbar-brand {
    font-weight: bold;
  }
  footer {
    border-top: 1px solid #CCC;
    margin-top: 60px;
    margin-bottom: 48px;
    opacity: 0.75;
  }
  .content-body>:first-child, .content-body>:first-child>:first-child {
    margin-top: 0 !important;
  }
  p code {
    white-space: inherit;
  }
</style>

<div class="fluid-row">
  <div class="col-sm-12">
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <a class="navbar-brand" href="./">P01 - Advanced R</a>
        </div>
      </div>
    </nav>
  </div>
</div>

<div class="fluid-row">
  <div class="col-sm-3">
    <div class="list-group">
      <a class="list-group-item" href="./">Introduction</a>
      <a class="list-group-item" href="refresheR.html">refreshR</a>
      <a class="list-group-item" href="creating_packages.html">Creating R packages</a>
      <a class="list-group-item" href="data_linkage.html">Data linkage</a>
      <a class="list-group-item" href="data_visualization.html">Data visualization</a>
      <a class="list-group-item" href="data_wrangling.html">Data wrangling</a>
      <a class="list-group-item" href="statistical_programming.html">Statistical programming</a>
      <a class="list-group-item" href="zelig.html">Zelig</a>
    </div>
    <script>
      // manage active state of toc based on current page
      var href = window.location.pathname;
      href = href.substr(href.lastIndexOf('/') + 1);
      if (href === "" || href === "index.html")
        href = "./";
      $('a.list-group-item[href="' + href + '"]').addClass('active');
    </script>
  </div>
  <div class="col-sm-9 content-body">


<div id="TOC">
<ul>
<li><a href="#scraping">Scraping</a><ul>
<li><a href="#more">More ?</a></li>
<li><a href="#the-xml-way">The XML way</a></li>
<li><a href="#downloading-loading-data">Downloading &amp; Loading Data</a></li>
</ul></li>
<li><a href="#manipulation-grammars">Manipulation grammars</a><ul>
<li><a href="#nycflights13-dataset"><code>nycflights13</code> dataset</a></li>
<li><a href="#load-data">Load data</a></li>
<li><a href="#create-datasets">Create datasets</a></li>
<li><a href="#pretty-print">Pretty-print</a></li>
<li><a href="#filter-rows">Filter rows</a></li>
<li><a href="#arrange-rows">Arrange rows</a></li>
<li><a href="#performance-tbc">Performance (TBC)</a></li>
<li><a href="#select-columns">Select columns</a></li>
<li><a href="#extract-distinct-unique-rows">Extract distinct (unique) rows</a></li>
<li><a href="#add-new-columns">Add new columns</a></li>
<li><a href="#create-new-dataset-from-columns">Create new dataset from columns</a></li>
<li><a href="#summarize-values">Summarize values</a></li>
<li><a href="#randomly-sample-rows">Randomly sample rows</a></li>
<li><a href="#grouped-operations">Grouped operations</a></li>
<li><a href="#chaining">Chaining</a></li>
<li><a href="#ceci-nest-pas-une-pipe-magritte">Ceci n’est pas une pipe (Magritte)</a></li>
<li><a href="#ceci-nest-pas-un-pipe-magrittr">Ceci n’est pas un pipe (<code>magrittr</code>)</a></li>
<li><a href="#chaining-1">Chaining</a></li>
<li><a href="#pipes">Pipes???</a></li>
</ul></li>
<li><a href="#not-always-as-expected">Not always as expected…</a></li>
<li><a href="#data.table-tricks"><code>data.table</code> tricks</a></li>
<li><a href="#databases">Databases</a><ul>
<li><a href="#supported-databases">Supported databases</a></li>
</ul></li>
<li><a href="#wrap-up">Wrap-up</a></li>
</ul>
</div>

<div id="scraping" class="section level1">
<h1>Scraping</h1>
<div align="center">
<img src="http://ia.media-imdb.com/images/M/MV5BMTg3NjU5MTk2Ml5BMl5BanBnXkFtZTgwNTY2MTE1MjE@._V1_SY317_CR5,0,214,317_AL_.jpg" alt="Drawing" style="height: 400px;"/>
</div>
<p><a href="http://www.imdb.com/title/tt0053779/" class="uri">http://www.imdb.com/title/tt0053779/</a></p>
<pre class="r"><code>library(rvest)
movie &lt;- html(&quot;http://www.imdb.com/title/tt0053779/&quot;)
movie %&gt;%
  html_nodes(&quot;#titleCast .itemprop span&quot;) %&gt;%
  html_text()</code></pre>
<pre><code>##  [1] &quot;Marcello Mastroianni&quot; &quot;Anita Ekberg&quot;         &quot;Anouk Aimée&quot;         
##  [4] &quot;Yvonne Furneaux&quot;      &quot;Magali Noël&quot;          &quot;Alain Cuny&quot;          
##  [7] &quot;Annibale Ninchi&quot;      &quot;Walter Santesso&quot;      &quot;Lex Barker&quot;          
## [10] &quot;Jacques Sernas&quot;       &quot;Nadia Gray&quot;           &quot;Valeria Ciangottini&quot; 
## [13] &quot;Riccardo Garrone&quot;     &quot;Ida Galli&quot;            &quot;Audrey McDonald&quot;</code></pre>
<div id="more" class="section level2">
<h2>More ?</h2>
<iframe src="https://en.wikipedia.org/wiki/List_of_highest-grossing_films" width="100%" height="400px" ;">
</iframe>
<pre class="r"><code>library(rvest)
d &lt;- html(&quot;https://en.wikipedia.org/wiki/List_of_highest-grossing_films&quot;) %&gt;%
  html_node(&quot;.wikitable&quot;) %&gt;% 
  html_table() %&gt;%
  head()</code></pre>
</div>
<div id="the-xml-way" class="section level2">
<h2>The XML way</h2>
<iframe src="http://energyalmanac.ca.gov/electricity/web_qfer/Heat_Rates.php" width="100%" height="400px" ;">
</iframe>
<pre class="r"><code>library(XML)</code></pre>
<pre><code>## 
## Attaching package: &#39;XML&#39;
## 
## The following object is masked from &#39;package:rvest&#39;:
## 
##     xml</code></pre>
<pre class="r"><code>d &lt;- readHTMLTable(&quot;http://energyalmanac.ca.gov/electricity/web_qfer/Heat_Rates.php&quot;, which = 1)
head(d)</code></pre>
<pre><code>##   Category v 2014 Â                                    Company Name
## 1        C     2014                             ACE Cogeneration Co
## 2        C     2014                        Karnavati Holdings, Inc.
## 3        C     2014 Los Angeles Department of Water &amp; Power (LADWP)
## 4        C     2014                                       Rio Bravo
## 5        C     2014                                       Rio Bravo
## 6        C     2014         Tesoro Refining &amp; Marketing Company LLC
##   Plant ID                                                Plant Name
## 1    C0001 ACE Cogeneration (ACE is Argus Cogen Expansion - Retired)
## 2    C0017                                         Argus Cogen Plant
## 3    C0023                          Intermountain Power Project (UT)
## 4    C0018                                          Rio Bravo Jasmin
## 5    C0022                                            Rio Bravo Poso
## 6    C0002                           Los Angeles Refinery - Calciner
##         Net MWh Main MMBTU        Heat Rate
## 1        333205    4596520 13.7948710253448
## 2        257374   13830280 53.7361194215422
## 3      12369820  115061800 9.30181684131216
## 4 72667.1015625     847439 11.6619347927498
## 5        116102    1334220 11.4917917004014
## 6        208442    3007930 14.4305370318842</code></pre>
</div>
<div id="downloading-loading-data" class="section level2">
<h2>Downloading &amp; Loading Data</h2>
</div>
</div>
<div id="manipulation-grammars" class="section level1">
<h1>Manipulation grammars</h1>
<div id="nycflights13-dataset" class="section level2">
<h2><code>nycflights13</code> dataset</h2>
<ul>
<li>We are going to compare 3 approaches to manipulate the same dataset:
<ol style="list-style-type: decimal">
<li><code>data.frame</code></li>
<li><code>data.table</code></li>
<li><code>dplyr</code> table (extension of <code>data.frame</code>, <code>data.table</code>-aware)</li>
</ol></li>
<li>There is no “best” approach and these data classes can be combined.</li>
</ul>
</div>
<div id="load-data" class="section level2">
<h2>Load data</h2>
<ul>
<li>Pre-packaged dataset:</li>
</ul>
<pre class="r"><code>library(nycflights13)
head(flights)</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
</div>
<div id="create-datasets" class="section level2">
<h2>Create datasets</h2>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;
## 
## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag
## 
## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>library(data.table)</code></pre>
<pre><code>## 
## Attaching package: &#39;data.table&#39;
## 
## The following objects are masked from &#39;package:dplyr&#39;:
## 
##     between, last</code></pre>
<pre class="r"><code>## Default is dplyr table
dp_flights &lt;- flights
## Explicit conversion
## dp_flights &lt;- tbl_df(flights)
## Base data frame
df_flights &lt;- data.frame(flights)
## Data table
dt_flights &lt;- data.table(flights)</code></pre>
</div>
<div id="pretty-print" class="section level2">
<h2>Pretty-print</h2>
<pre class="r"><code>head(df_flights)</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
<pre class="r"><code>dp_flights</code></pre>
<pre><code>## Source: local data frame [336,776 x 16]
## 
##    year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1  2013     1   1      517         2      830        11      UA  N14228
## 2  2013     1   1      533         4      850        20      UA  N24211
## 3  2013     1   1      542         2      923        33      AA  N619AA
## 4  2013     1   1      544        -1     1004       -18      B6  N804JB
## 5  2013     1   1      554        -6      812       -25      DL  N668DN
## 6  2013     1   1      554        -4      740        12      UA  N39463
## 7  2013     1   1      555        -5      913        19      B6  N516JB
## 8  2013     1   1      557        -3      709       -14      EV  N829AS
## 9  2013     1   1      557        -3      838        -8      B6  N593JB
## 10 2013     1   1      558        -2      753         8      AA  N3ALAA
## ..  ...   ... ...      ...       ...      ...       ...     ...     ...
## Variables not shown: flight (int), origin (chr), dest (chr), air_time
##   (dbl), distance (dbl), hour (dbl), minute (dbl)</code></pre>
<pre class="r"><code>dt_flights</code></pre>
<pre><code>##         year month day dep_time dep_delay arr_time arr_delay carrier
##      1: 2013     1   1      517         2      830        11      UA
##      2: 2013     1   1      533         4      850        20      UA
##      3: 2013     1   1      542         2      923        33      AA
##      4: 2013     1   1      544        -1     1004       -18      B6
##      5: 2013     1   1      554        -6      812       -25      DL
##     ---                                                             
## 336772: 2013     9  30       NA        NA       NA        NA      9E
## 336773: 2013     9  30       NA        NA       NA        NA      9E
## 336774: 2013     9  30       NA        NA       NA        NA      MQ
## 336775: 2013     9  30       NA        NA       NA        NA      MQ
## 336776: 2013     9  30       NA        NA       NA        NA      MQ
##         tailnum flight origin dest air_time distance hour minute
##      1:  N14228   1545    EWR  IAH      227     1400    5     17
##      2:  N24211   1714    LGA  IAH      227     1416    5     33
##      3:  N619AA   1141    JFK  MIA      160     1089    5     42
##      4:  N804JB    725    JFK  BQN      183     1576    5     44
##      5:  N668DN    461    LGA  ATL      116      762    5     54
##     ---                                                         
## 336772:           3393    JFK  DCA       NA      213   NA     NA
## 336773:           3525    LGA  SYR       NA      198   NA     NA
## 336774:  N535MQ   3461    LGA  BNA       NA      764   NA     NA
## 336775:  N511MQ   3572    LGA  CLE       NA      419   NA     NA
## 336776:  N839MQ   3531    LGA  RDU       NA      431   NA     NA</code></pre>
</div>
<div id="filter-rows" class="section level2">
<h2>Filter rows</h2>
<pre class="r"><code>head(df_flights[df_flights$month == 1 &amp; df_flights$day == 1, ])</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
<pre class="r"><code>head(df_flights[1:10, ])</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
<pre class="r"><code>head(df_flights[1:10, ])
slice(dp_flights, 1:10)
dt_flights[1:10]</code></pre>
</div>
<div id="arrange-rows" class="section level2">
<h2>Arrange rows</h2>
<pre class="r"><code>head(with(df_flights, df_flights[order(year, month, day), ]))</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
<pre class="r"><code>head(with(df_flights, df_flights[order(year, month, day), ]))
arrange(dp_flights, year, month, day)
dt_flights[order(year, month, day)]</code></pre>
<pre class="r"><code>head(with(df_flights, df_flights[order(-arr_delay), ]))</code></pre>
<pre><code>##        year month day dep_time dep_delay arr_time arr_delay carrier
## 7073   2013     1   9      641      1301     1242      1272      HA
## 235779 2013     6  15     1432      1137     1607      1127      MQ
## 8240   2013     1  10     1121      1126     1239      1109      MQ
## 327044 2013     9  20     1139      1014     1457      1007      AA
## 270377 2013     7  22      845      1005     1044       989      MQ
## 173993 2013     4  10     1100       960     1342       931      DL
##        tailnum flight origin dest air_time distance hour minute
## 7073    N384HA     51    JFK  HNL      640     4983    6     41
## 235779  N504MQ   3535    JFK  CMH       74      483   14     32
## 8240    N517MQ   3695    EWR  ORD      111      719   11     21
## 327044  N338AA    177    JFK  SFO      354     2586   11     39
## 270377  N665MQ   3075    JFK  CVG       96      589    8     45
## 173993  N959DL   2391    JFK  TPA      139     1005   11      0</code></pre>
<pre class="r"><code>head(with(df_flights, df_flights[order(-arr_delay), ]))
arrange(flights, desc(arr_delay))
dt_flights[order(-arr_delay)]</code></pre>
</div>
<div id="performance-tbc" class="section level2">
<h2>Performance (TBC)</h2>
<pre class="r"><code>system.time(with(df_flights, df_flights[order(-arr_delay), ]))</code></pre>
<pre><code>##    user  system elapsed 
##   0.223   0.011   0.234</code></pre>
<pre class="r"><code>system.time(arrange(flights, desc(arr_delay)))</code></pre>
<pre><code>##    user  system elapsed 
##   0.151   0.004   0.154</code></pre>
<pre class="r"><code>system.time(dt_flights[order(-arr_delay)])</code></pre>
<pre><code>##    user  system elapsed 
##   0.088   0.002   0.090</code></pre>
</div>
<div id="select-columns" class="section level2">
<h2>Select columns</h2>
<pre class="r"><code>head(select(df_flights, year, month, day))</code></pre>
<pre><code>##   year month day
## 1 2013     1   1
## 2 2013     1   1
## 3 2013     1   1
## 4 2013     1   1
## 5 2013     1   1
## 6 2013     1   1</code></pre>
<pre class="r"><code>head(select(df_flights, year, month, day))
select(dp_flights, year, month, day)
dt_flights[, .(year, month, day)]
dt_flights[, list(year, month, day)]</code></pre>
<pre class="r"><code>## Not as expected!
dt_flights[, c(&quot;year&quot;, &quot;month&quot;, &quot;day&quot;)]</code></pre>
<pre><code>## [1] &quot;year&quot;  &quot;month&quot; &quot;day&quot;</code></pre>
<pre class="r"><code>dt_flights[, c(&quot;year&quot;, &quot;month&quot;, &quot;day&quot;), with = FALSE]</code></pre>
<pre><code>##         year month day
##      1: 2013     1   1
##      2: 2013     1   1
##      3: 2013     1   1
##      4: 2013     1   1
##      5: 2013     1   1
##     ---               
## 336772: 2013     9  30
## 336773: 2013     9  30
## 336774: 2013     9  30
## 336775: 2013     9  30
## 336776: 2013     9  30</code></pre>
</div>
<div id="extract-distinct-unique-rows" class="section level2">
<h2>Extract distinct (unique) rows</h2>
<pre class="r"><code>head(unique(df_flights, by = &quot;tailnum&quot;))</code></pre>
<pre><code>##   year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1 2013     1   1      517         2      830        11      UA  N14228
## 2 2013     1   1      533         4      850        20      UA  N24211
## 3 2013     1   1      542         2      923        33      AA  N619AA
## 4 2013     1   1      544        -1     1004       -18      B6  N804JB
## 5 2013     1   1      554        -6      812       -25      DL  N668DN
## 6 2013     1   1      554        -4      740        12      UA  N39463
##   flight origin dest air_time distance hour minute
## 1   1545    EWR  IAH      227     1400    5     17
## 2   1714    LGA  IAH      227     1416    5     33
## 3   1141    JFK  MIA      160     1089    5     42
## 4    725    JFK  BQN      183     1576    5     44
## 5    461    LGA  ATL      116      762    5     54
## 6   1696    EWR  ORD      150      719    5     54</code></pre>
<pre class="r"><code>head(unique(df_flights, by = &quot;tailnum&quot;))
distinct(select(flights, tailnum))
unique(dt_flights, by = &quot;tailnum&quot;)</code></pre>
</div>
<div id="add-new-columns" class="section level2">
<h2>Add new columns</h2>
<pre class="r"><code>## Copy
df_flights$gain &lt;-
  df_flights$arr_delay - df_flights$dep_delay
df_flights$speed &lt;-
  df_flights$distance / df_flights$air_time * 60</code></pre>
<pre class="r"><code>## Copy
mutate(dp_flights,
       gain = arr_delay - dep_delay,
       speed = distance / air_time * 60)</code></pre>
<pre><code>## Source: local data frame [336,776 x 18]
## 
##    year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1  2013     1   1      517         2      830        11      UA  N14228
## 2  2013     1   1      533         4      850        20      UA  N24211
## 3  2013     1   1      542         2      923        33      AA  N619AA
## 4  2013     1   1      544        -1     1004       -18      B6  N804JB
## 5  2013     1   1      554        -6      812       -25      DL  N668DN
## 6  2013     1   1      554        -4      740        12      UA  N39463
## 7  2013     1   1      555        -5      913        19      B6  N516JB
## 8  2013     1   1      557        -3      709       -14      EV  N829AS
## 9  2013     1   1      557        -3      838        -8      B6  N593JB
## 10 2013     1   1      558        -2      753         8      AA  N3ALAA
## ..  ...   ... ...      ...       ...      ...       ...     ...     ...
## Variables not shown: flight (int), origin (chr), dest (chr), air_time
##   (dbl), distance (dbl), hour (dbl), minute (dbl), gain (dbl), speed (dbl)</code></pre>
<pre class="r"><code>## In-place
dt_flights[, gain := arr_delay - dep_delay]</code></pre>
<pre><code>##         year month day dep_time dep_delay arr_time arr_delay carrier
##      1: 2013     1   1      517         2      830        11      UA
##      2: 2013     1   1      533         4      850        20      UA
##      3: 2013     1   1      542         2      923        33      AA
##      4: 2013     1   1      544        -1     1004       -18      B6
##      5: 2013     1   1      554        -6      812       -25      DL
##     ---                                                             
## 336772: 2013     9  30       NA        NA       NA        NA      9E
## 336773: 2013     9  30       NA        NA       NA        NA      9E
## 336774: 2013     9  30       NA        NA       NA        NA      MQ
## 336775: 2013     9  30       NA        NA       NA        NA      MQ
## 336776: 2013     9  30       NA        NA       NA        NA      MQ
##         tailnum flight origin dest air_time distance hour minute gain
##      1:  N14228   1545    EWR  IAH      227     1400    5     17    9
##      2:  N24211   1714    LGA  IAH      227     1416    5     33   16
##      3:  N619AA   1141    JFK  MIA      160     1089    5     42   31
##      4:  N804JB    725    JFK  BQN      183     1576    5     44  -17
##      5:  N668DN    461    LGA  ATL      116      762    5     54  -19
##     ---                                                              
## 336772:           3393    JFK  DCA       NA      213   NA     NA   NA
## 336773:           3525    LGA  SYR       NA      198   NA     NA   NA
## 336774:  N535MQ   3461    LGA  BNA       NA      764   NA     NA   NA
## 336775:  N511MQ   3572    LGA  CLE       NA      419   NA     NA   NA
## 336776:  N839MQ   3531    LGA  RDU       NA      431   NA     NA   NA</code></pre>
<pre class="r"><code>dt_flights[, speed := arr_delay - dep_delay,
           distance / air_time * 60]</code></pre>
<pre><code>##         year month day dep_time dep_delay arr_time arr_delay carrier
##      1: 2013     1   1      517         2      830        11      UA
##      2: 2013     1   1      533         4      850        20      UA
##      3: 2013     1   1      542         2      923        33      AA
##      4: 2013     1   1      544        -1     1004       -18      B6
##      5: 2013     1   1      554        -6      812       -25      DL
##     ---                                                             
## 336772: 2013     9  30       NA        NA       NA        NA      9E
## 336773: 2013     9  30       NA        NA       NA        NA      9E
## 336774: 2013     9  30       NA        NA       NA        NA      MQ
## 336775: 2013     9  30       NA        NA       NA        NA      MQ
## 336776: 2013     9  30       NA        NA       NA        NA      MQ
##         tailnum flight origin dest air_time distance hour minute gain
##      1:  N14228   1545    EWR  IAH      227     1400    5     17    9
##      2:  N24211   1714    LGA  IAH      227     1416    5     33   16
##      3:  N619AA   1141    JFK  MIA      160     1089    5     42   31
##      4:  N804JB    725    JFK  BQN      183     1576    5     44  -17
##      5:  N668DN    461    LGA  ATL      116      762    5     54  -19
##     ---                                                              
## 336772:           3393    JFK  DCA       NA      213   NA     NA   NA
## 336773:           3525    LGA  SYR       NA      198   NA     NA   NA
## 336774:  N535MQ   3461    LGA  BNA       NA      764   NA     NA   NA
## 336775:  N511MQ   3572    LGA  CLE       NA      419   NA     NA   NA
## 336776:  N839MQ   3531    LGA  RDU       NA      431   NA     NA   NA
##         speed
##      1:     9
##      2:    16
##      3:    31
##      4:   -17
##      5:   -19
##     ---      
## 336772:    NA
## 336773:    NA
## 336774:    NA
## 336775:    NA
## 336776:    NA</code></pre>
</div>
<div id="create-new-dataset-from-columns" class="section level2">
<h2>Create new dataset from columns</h2>
<pre class="r"><code>df_flights_2 &lt;- data.frame(gain = df_flights$arr_delay - df_flights$dep_delay,
                           speed = df_flights$distance / df_flights$air_time * 60)
head(df_flights_2)</code></pre>
<pre><code>##   gain    speed
## 1    9 370.0441
## 2   16 374.2731
## 3   31 408.3750
## 4  -17 516.7213
## 5  -19 394.1379
## 6   16 287.6000</code></pre>
<pre class="r"><code>transmute(dp_flights,
          gain = arr_delay - dep_delay,
          speed = distance / air_time * 60)</code></pre>
<pre><code>## Source: local data frame [336,776 x 2]
## 
##    gain    speed
## 1     9 370.0441
## 2    16 374.2731
## 3    31 408.3750
## 4   -17 516.7213
## 5   -19 394.1379
## 6    16 287.6000
## 7    24 404.4304
## 8   -11 259.2453
## 9    -5 404.5714
## 10   10 318.6957
## ..  ...      ...</code></pre>
<pre class="r"><code>dt_flights[, .(gain = arr_delay - dep_delay,
               gain_per_hour = gain / (air_time / 60))]</code></pre>
<pre><code>##         gain gain_per_hour
##      1:    9      2.378855
##      2:   16      4.229075
##      3:   31     11.625000
##      4:  -17     -5.573770
##      5:  -19     -9.827586
##     ---                   
## 336772:   NA            NA
## 336773:   NA            NA
## 336774:   NA            NA
## 336775:   NA            NA
## 336776:   NA            NA</code></pre>
<pre class="r"><code>dt_flights[, list(gain = arr_delay - dep_delay,
                  gain_per_hour = gain / (air_time / 60))]</code></pre>
<pre><code>##         gain gain_per_hour
##      1:    9      2.378855
##      2:   16      4.229075
##      3:   31     11.625000
##      4:  -17     -5.573770
##      5:  -19     -9.827586
##     ---                   
## 336772:   NA            NA
## 336773:   NA            NA
## 336774:   NA            NA
## 336775:   NA            NA
## 336776:   NA            NA</code></pre>
</div>
<div id="summarize-values" class="section level2">
<h2>Summarize values</h2>
<pre class="r"><code>mean(df_flights$dep_delay, na.rm = TRUE)</code></pre>
<pre><code>## [1] 12.63907</code></pre>
<pre class="r"><code>summarise(dp_flights,
          delay = mean(dep_delay, na.rm = TRUE))

dt_flights[, .(delay = mean(dep_delay, na.rm = TRUE))]
dt_flights[, list(delay = mean(dep_delay, na.rm = TRUE))]</code></pre>
</div>
<div id="randomly-sample-rows" class="section level2">
<h2>Randomly sample rows</h2>
<pre class="r"><code>set.seed(1234)
head(df_flights[sample(nrow(df_flights), 10), ])</code></pre>
<pre><code>##        year month day dep_time dep_delay arr_time arr_delay carrier
## 38293  2013    10  13      838         8     1132         8      UA
## 209575 2013     5  18      957        -3     1253       -33      DL
## 205188 2013     5  13     1730        21     2024       -15      UA
## 209938 2013     5  18     1728        -1     1948       -28      UA
## 289933 2013     8  11     1521        41     1808        33      UA
## 215639 2013     5  24     1836        61     2032        64      US
##        tailnum flight origin dest air_time distance hour minute gain
## 38293   N13248   1626    EWR  SAN      331     2425    8     38    0
## 209575  N713TW   1765    JFK  SFO      327     2586    9     57  -30
## 205188  N555UA    512    JFK  SFO      327     2586   17     30  -36
## 209938  N17139   1265    EWR  MCO      121      937   17     28  -27
## 289933  N81449   1242    EWR  FLL      151     1065   15     21   -8
## 215639  N651AW    449    EWR  CLT       80      529   18     36    3
##           speed
## 38293  439.5770
## 209575 474.4954
## 205188 474.4954
## 209938 464.6281
## 289933 423.1788
## 215639 396.7500</code></pre>
<pre class="r"><code>sample_n(dp_flights, 10)</code></pre>
<pre><code>## Source: local data frame [10 x 16]
## 
##    year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1  2013     6  13      825        -5      949        -1      AA  N3EEAA
## 2  2013     4  20     1222       -10     1449        23      EV  N14573
## 3  2013    12  13     1856         1     2226        -9      VX  N635VA
## 4  2013     9   3      753        -7     1021       -39      AA  N329AA
## 5  2013    12  17     1611        81     2018       136      B6  N534JB
## 6  2013     8   3      735        -5     1059         4      VX  N845VA
## 7  2013    12  15     1329        64     1649        74      AA  N5DLAA
## 8  2013    12   8      843        -7     1030        -5      AA  N4XKAA
## 9  2013    11   8     1419        -1     1552        -3      AA  N554AA
## 10 2013    11  25      754        -6     1055       -20      AA  N3GLAA
## Variables not shown: flight (int), origin (chr), dest (chr), air_time
##   (dbl), distance (dbl), hour (dbl), minute (dbl)</code></pre>
<pre class="r"><code>dt_flights[sample(.N, 10)]</code></pre>
<pre><code>##     year month day dep_time dep_delay arr_time arr_delay carrier tailnum
##  1: 2013    12  26     1733        -2     1904       -21      AA  N466AA
##  2: 2013    12  21      824        15     1216        62      B6  N807JB
##  3: 2013    10  29     1447        -3     1722       -23      UA  N402UA
##  4: 2013     1  16     1245        76     1613        95      B6  N766JB
##  5: 2013    11  20      858        -2     1120       -19      DL  N3761R
##  6: 2013     7  24     1939       -11     2114       -16      AA  N4XMAA
##  7: 2013     4  13     1453        -2     1817        -3      AA  N397AA
##  8: 2013     8  30     1347        -1     1458       -11      B6  N368JB
##  9: 2013     8   1      652        -8      952       -14      DL  N907DE
## 10: 2013     1  18     1441        -4     1657        -8      UA  N534UA
##     flight origin dest air_time distance hour minute gain speed
##  1:    345    LGA  ORD      130      733   17     33  -19   -19
##  2:    901    JFK  FLL      164     1069    8     24   47    47
##  3:    370    EWR  MCO      130      937   14     47  -20   -20
##  4:    133    JFK  RSW      170     1074   12     45   19    19
##  5:   1747    LGA  ATL      111      762    8     58  -17   -17
##  6:    363    LGA  ORD      111      733   19     39   -5    -5
##  7:   1769    JFK  MIA      167     1089   14     53   -1    -1
##  8:    308    JFK  PWM       47      273   13     47  -10   -10
##  9:   2003    LGA  MIA      158     1096    6     52   -6    -6
## 10:    407    EWR  DEN      233     1605   14     41   -4    -4</code></pre>
<pre class="r"><code>head(df_flights[sample(round(.N * 0.01)), ])</code></pre>
<pre><code>##  [1] year      month     day       dep_time  dep_delay arr_time  arr_delay
##  [8] carrier   tailnum   flight    origin    dest      air_time  distance 
## [15] hour      minute    gain      speed    
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<pre class="r"><code>sample_frac(dp_flights, 0.01)</code></pre>
<pre><code>## Source: local data frame [3,368 x 16]
## 
##    year month day dep_time dep_delay arr_time arr_delay carrier tailnum
## 1  2013     3  19     1718        -2     1845       -30      AA  N3FHAA
## 2  2013    12   7     1153        13     1407         6      DL  N977AT
## 3  2013    12  22      604         4      829         4      WN  N251WN
## 4  2013     4   7      730         0     1054       -11      VX  N851VA
## 5  2013    11   6     1520         0     1715        10      AA  N4WNAA
## 6  2013     7   7      745         5     1041       -14      VX  N848VA
## 7  2013    11  13     1917        12     2135       -30      AA  N540AA
## 8  2013    12   5      644        -6     1038        16      UA  N75429
## 9  2013     9  27     2049        -5     2345       -14      B6  N625JB
## 10 2013     7  23     1958        99     2301       103      B6  N547JB
## ..  ...   ... ...      ...       ...      ...       ...     ...     ...
## Variables not shown: flight (int), origin (chr), dest (chr), air_time
##   (dbl), distance (dbl), hour (dbl), minute (dbl)</code></pre>
<pre class="r"><code>dt_flights[sample(round(.N * 0.01))]</code></pre>
<pre><code>##       year month day dep_time dep_delay arr_time arr_delay carrier tailnum
##    1: 2013     1   1     1655         0     2025        -5      VX  N626VA
##    2: 2013     1   4     1318        19     1442        24      B6  N203JB
##    3: 2013     1   2      933         4     1305        34      UA  N421UA
##    4: 2013     1   1     1600       -10     1712       -17      9E  N8968E
##    5: 2013     1   4     1315         0     1604        -7      B6  N536JB
##   ---                                                                     
## 3364: 2013     1   2     1719        -6     1857         2      MQ  N605MQ
## 3365: 2013     1   1     1127        -3     1504        16      UA  N518UA
## 3366: 2013     1   3     1044        -6     1358         0      B6  N639JB
## 3367: 2013     1   4     1706        -4     2007        -8      AA  N3HKAA
## 3368: 2013     1   3     1055        -5     1348        10      DL  N674DL
##       flight origin dest air_time distance hour minute gain speed
##    1:    413    JFK  LAX      362     2475   16     55   -5    -5
##    2:     32    JFK  ROC       61      264   13     18    5     5
##    3:    279    EWR  FLL      161     1065    9     33   30    30
##    4:   4088    JFK  PHL       35       94   16      0   -7    -7
##    5:    505    EWR  FLL      153     1065   13     15   -7    -7
##   ---                                                            
## 3364:   4255    JFK  BNA      134      765   17     19    8     8
## 3365:    703    JFK  LAX      357     2475   11     27   19    19
## 3366:    373    LGA  FLL      171     1076   10     44    6     6
## 3367:    695    JFK  AUS      223     1521   17      6   -4    -4
## 3368:   1647    LGA  ATL      129      762   10     55   15    15</code></pre>
</div>
<div id="grouped-operations" class="section level2">
<h2>Grouped operations</h2>
<pre class="r"><code>by_tailnum &lt;- group_by(dp_flights, tailnum)

dp_delay &lt;- summarise(by_tailnum,
                      count = n(),
                      dist = mean(distance, na.rm = TRUE),
                      delay = mean(arr_delay, na.rm = TRUE))
dp_delay &lt;- filter(dp_delay, count &gt; 20, dist &lt; 2000)
dp_delay</code></pre>
<pre><code>## Source: local data frame [2,962 x 4]
## 
##    tailnum count     dist      delay
## 1           2512 710.2576        NaN
## 2   N0EGMQ   371 676.1887  9.9829545
## 3   N10156   153 757.9477 12.7172414
## 4   N102UW    48 535.8750  2.9375000
## 5   N103US    46 535.1957 -6.9347826
## 6   N104UW    47 535.2553  1.8043478
## 7   N10575   289 519.7024 20.6914498
## 8   N105UW    45 524.8444 -0.2666667
## 9   N107US    41 528.7073 -5.7317073
## 10  N108UW    60 534.5000 -1.2500000
## ..     ...   ...      ...        ...</code></pre>
<pre class="r"><code>dt_delay &lt;-
  dt_flights[, .(count = .N,
                 dist = mean(distance, na.rm = TRUE),
                 delay = mean(arr_delay, na.rm = TRUE)),
             by = list(tailnum)][count &gt; 20 &amp;  dist &lt; 2000]
dt_delay</code></pre>
<pre><code>##       tailnum count      dist     delay
##    1:  N14228   111 1546.9640  3.711712
##    2:  N24211   130 1330.2615  7.700000
##    3:  N619AA    24 1339.2083  7.652174
##    4:  N804JB   219 1424.6210 -1.860465
##    5:  N668DN    49 1027.5918  2.625000
##   ---                                  
## 2958:  N330NB    44  813.2045  3.409091
## 2959:  N354NB    26  816.8077  7.615385
## 2960:  N331NB    59  791.4576 12.593220
## 2961:  N352NB    42  672.5952 15.536585
## 2962:  N823MQ    38  315.7368  9.351351</code></pre>
</div>
<div id="chaining" class="section level2">
<h2>Chaining</h2>
<pre class="r"><code>a1 &lt;- group_by(flights, year, month, day)
a2 &lt;- select(a1, arr_delay, dep_delay)
a3 &lt;- summarise(a2,
                arr = mean(arr_delay, na.rm = TRUE),
                dep = mean(dep_delay, na.rm = TRUE))
a4 &lt;- filter(a3, arr &gt; 30 | dep &gt; 30)
a4</code></pre>
<pre><code>## Source: local data frame [49 x 5]
## Groups: year, month
## 
##    year month day      arr      dep
## 1  2013     1  16 34.24736 24.61287
## 2  2013     1  31 32.60285 28.65836
## 3  2013     2  11 36.29009 39.07360
## 4  2013     2  27 31.25249 37.76327
## 5  2013     3   8 85.86216 83.53692
## 6  2013     3  18 41.29189 30.11796
## 7  2013     4  10 38.41231 33.02368
## 8  2013     4  12 36.04814 34.83843
## 9  2013     4  18 36.02848 34.91536
## 10 2013     4  19 47.91170 46.12783
## ..  ...   ... ...      ...      ...</code></pre>
<pre class="r"><code>filter(
  summarise(
    select(
      group_by(flights, year, month, day),
      arr_delay, dep_delay
      ),
    arr = mean(arr_delay, na.rm = TRUE),
    dep = mean(dep_delay, na.rm = TRUE)
    ),
  arr &gt; 30 | dep &gt; 30
  )</code></pre>
<pre><code>## Source: local data frame [49 x 5]
## Groups: year, month
## 
##    year month day      arr      dep
## 1  2013     1  16 34.24736 24.61287
## 2  2013     1  31 32.60285 28.65836
## 3  2013     2  11 36.29009 39.07360
## 4  2013     2  27 31.25249 37.76327
## 5  2013     3   8 85.86216 83.53692
## 6  2013     3  18 41.29189 30.11796
## 7  2013     4  10 38.41231 33.02368
## 8  2013     4  12 36.04814 34.83843
## 9  2013     4  18 36.02848 34.91536
## 10 2013     4  19 47.91170 46.12783
## ..  ...   ... ...      ...      ...</code></pre>
</div>
<div id="ceci-nest-pas-une-pipe-magritte" class="section level2">
<h2>Ceci n’est pas une pipe (Magritte)</h2>
<p><img src="images/MagrittePipe.jpg" alt="img" /></p>
</div>
<div id="ceci-nest-pas-un-pipe-magrittr" class="section level2">
<h2>Ceci n’est pas un pipe (<code>magrittr</code>)</h2>
<p><img src="images/magrittr.jpg" alt="img" /></p>
</div>
<div id="chaining-1" class="section level2">
<h2>Chaining</h2>
<pre class="r"><code>flights %&gt;%
  group_by(year, month, day) %&gt;%
  select(arr_delay, dep_delay) %&gt;%
  summarise(
    arr = mean(arr_delay, na.rm = TRUE),
    dep = mean(dep_delay, na.rm = TRUE)
    ) %&gt;%
  filter(arr &gt; 30 | dep &gt; 30)</code></pre>
<pre><code>## Source: local data frame [49 x 5]
## Groups: year, month
## 
##    year month day      arr      dep
## 1  2013     1  16 34.24736 24.61287
## 2  2013     1  31 32.60285 28.65836
## 3  2013     2  11 36.29009 39.07360
## 4  2013     2  27 31.25249 37.76327
## 5  2013     3   8 85.86216 83.53692
## 6  2013     3  18 41.29189 30.11796
## 7  2013     4  10 38.41231 33.02368
## 8  2013     4  12 36.04814 34.83843
## 9  2013     4  18 36.02848 34.91536
## 10 2013     4  19 47.91170 46.12783
## ..  ...   ... ...      ...      ...</code></pre>
<pre class="r"><code>dt_delay &lt;- dt_flights[, .(count = .N,
                           dist = mean(distance, na.rm = TRUE),
                           delay = mean(arr_delay, na.rm = TRUE)),
                       by = list(tailnum)][count &gt; 20 &amp;  dist &lt; 2000]
dt_delay</code></pre>
<pre><code>##       tailnum count      dist     delay
##    1:  N14228   111 1546.9640  3.711712
##    2:  N24211   130 1330.2615  7.700000
##    3:  N619AA    24 1339.2083  7.652174
##    4:  N804JB   219 1424.6210 -1.860465
##    5:  N668DN    49 1027.5918  2.625000
##   ---                                  
## 2958:  N330NB    44  813.2045  3.409091
## 2959:  N354NB    26  816.8077  7.615385
## 2960:  N331NB    59  791.4576 12.593220
## 2961:  N352NB    42  672.5952 15.536585
## 2962:  N823MQ    38  315.7368  9.351351</code></pre>
</div>
<div id="pipes" class="section level2">
<h2>Pipes???</h2>
<p><code>magrittr</code> <a href="https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html">vignette</a>:</p>
<blockquote>
<p>We start with a value, here mtcars (a data.frame). Based on this, we first extract a subset, then we aggregate the information based on the number of cylinders, and then we transform the dataset by adding a variable for kilometers per liter as supplement to miles per gallon. Finally we print the result before assigning it. Note how the code is arranged in the logical order of how you think about the task: data-&gt;transform-&gt;aggregate, which is also the same order as the code will execute. It’s like a recipe – easy to read, easy to follow!</p>
</blockquote>
<pre class="r"><code>library(magrittr)
car_data &lt;- 
  mtcars %&gt;%
  subset(hp &gt; 100) %&gt;%
  aggregate(. ~ cyl, data = ., FUN = . %&gt;% mean %&gt;% round(2)) %&gt;%
  transform(kpl = mpg %&gt;% multiply_by(0.4251)) %&gt;%
  print</code></pre>
<pre><code>##   cyl   mpg   disp     hp drat   wt  qsec   vs   am gear carb       kpl
## 1   4 25.90 108.05 111.00 3.94 2.15 17.75 1.00 1.00 4.50 2.00 11.010090
## 2   6 19.74 183.31 122.29 3.59 3.12 17.98 0.57 0.43 3.86 3.43  8.391474
## 3   8 15.10 353.10 209.21 3.23 4.00 16.77 0.00 0.14 3.29 3.50  6.419010</code></pre>
<pre class="r"><code>dt_mtcars &lt;- data.table(mtcars)
dt_car_data &lt;- dt_mtcars[hp &gt; 100][, lapply(.SD, function(x) round(mean(x), 2)),
                                   by = &quot;cyl&quot;][, kpl := mpg*0.4251]
dt_car_data</code></pre>
<pre><code>##    cyl   mpg   disp     hp drat   wt  qsec   vs   am gear carb       kpl
## 1:   6 19.74 183.31 122.29 3.59 3.12 17.98 0.57 0.43 3.86 3.43  8.391474
## 2:   8 15.10 353.10 209.21 3.23 4.00 16.77 0.00 0.14 3.29 3.50  6.419010
## 3:   4 25.90 108.05 111.00 3.94 2.15 17.75 1.00 1.00 4.50 2.00 11.010090</code></pre>
</div>
</div>
<div id="not-always-as-expected" class="section level1">
<h1>Not always as expected…</h1>
<pre class="r"><code>dt_mtcars &lt;- data.table(mtcars)
names(dt_mtcars)</code></pre>
<pre><code>##  [1] &quot;mpg&quot;  &quot;cyl&quot;  &quot;disp&quot; &quot;hp&quot;   &quot;drat&quot; &quot;wt&quot;   &quot;qsec&quot; &quot;vs&quot;   &quot;am&quot;   &quot;gear&quot;
## [11] &quot;carb&quot;</code></pre>
<pre class="r"><code>names(dt_mtcars)[1] &lt;- &quot;MPG&quot;</code></pre>
<pre><code>## Warning in `names&lt;-.data.table`(`*tmp*`, value = c(&quot;MPG&quot;, &quot;cyl&quot;, &quot;disp&quot;, :
## The names(x)&lt;-value syntax copies the whole table. This is due to &lt;- in
## R itself. Please change to setnames(x,old,new) which does not copy and
## is faster. See help(&#39;setnames&#39;). You can safely ignore this warning if it
## is inconvenient to change right now. Setting options(warn=2) turns this
## warning into an error, so you can then use traceback() to find and change
## your names&lt;- calls.</code></pre>
<p>Let’s try again:</p>
<pre class="r"><code>dt_mtcars &lt;- data.table(mtcars)
names(dt_mtcars)</code></pre>
<pre><code>##  [1] &quot;mpg&quot;  &quot;cyl&quot;  &quot;disp&quot; &quot;hp&quot;   &quot;drat&quot; &quot;wt&quot;   &quot;qsec&quot; &quot;vs&quot;   &quot;am&quot;   &quot;gear&quot;
## [11] &quot;carb&quot;</code></pre>
<pre class="r"><code># same:
setnames(dt_mtcars, &quot;mpg&quot;, &quot;MPG&quot;)
setnames(dt_mtcars, names(dt_mtcars)[1], &quot;MPG&quot;)</code></pre>
<p>No:</p>
<pre class="r"><code>f &lt;- function(dt, selected_variables = c(&quot;gear&quot;, &quot;carb&quot;)) {
  return(dt[, selected_variables])
}

f(dt_mtcars)</code></pre>
<pre><code>## [1] &quot;gear&quot; &quot;carb&quot;</code></pre>
<p>Almost:</p>
<pre class="r"><code>f &lt;- function(dt, selected_variables = c(&quot;gear&quot;, &quot;carb&quot;)) {
  return(dt[, get(selected_variables)])
}

f(dt_mtcars)</code></pre>
<pre><code>##  [1] 4 4 4 3 3 3 3 4 4 4 4 3 3 3 3 3 3 4 4 4 3 3 3 3 3 4 5 5 5 5 5 4</code></pre>
<p>Yes:</p>
<pre class="r"><code>f &lt;- function(dt, selected_variables = c(&quot;gear&quot;, &quot;carb&quot;)) {
  return(dt[get(selected_variables)])
}

f(dt_mtcars)</code></pre>
<pre><code>##      MPG cyl disp  hp drat    wt  qsec vs am gear carb
##  1: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
##  2: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
##  3: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
##  4: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
##  5: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
##  6: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
##  7: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
##  8: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
##  9: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 10: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 11: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 12: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 13: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 14: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 15: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 16: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 17: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 18: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 19: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 20: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 21: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 22: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 23: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 24: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 25: 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## 26: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## 27: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## 28: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## 29: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## 30: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## 31: 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## 32: 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
##      MPG cyl disp  hp drat    wt  qsec vs am gear carb</code></pre>
</div>
<div id="data.table-tricks" class="section level1">
<h1><code>data.table</code> tricks</h1>
<ul>
<li>very fast <code>fread</code></li>
<li>very fast <code>merge</code></li>
</ul>
<p>Number of elements in a group:</p>
<pre class="r"><code>dt_mtcars[, .N, by = &quot;cyl&quot;]</code></pre>
<pre><code>##    cyl  N
## 1:   6  7
## 2:   4 11
## 3:   8 14</code></pre>
<p>All columns:</p>
<pre class="r"><code>dt_mtcars[, .SD]</code></pre>
<pre><code>##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb
##  1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
##  2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
##  3: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
##  4: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
##  5: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
##  6: 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
##  7: 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
##  8: 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
##  9: 22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
## 10: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 11: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## 12: 16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## 13: 17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## 14: 15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## 15: 10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## 16: 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## 17: 14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## 18: 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
## 19: 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
## 20: 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
## 21: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
## 22: 15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## 23: 15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## 24: 13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## 25: 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## 26: 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
## 27: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 28: 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 29: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 30: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 31: 15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
## 32: 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb</code></pre>
<p>Using keys:</p>
<pre class="r"><code>setkey(dt_mtcars, &quot;cyl&quot;)
dt_mtcars</code></pre>
<pre><code>##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb
##  1: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
##  2: 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
##  3: 22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
##  4: 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
##  5: 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
##  6: 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
##  7: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
##  8: 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
##  9: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 10: 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 11: 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 12: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 13: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 14: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 15: 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## 16: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 17: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## 18: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 19: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 20: 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## 21: 16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## 22: 17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## 23: 15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## 24: 10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## 25: 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## 26: 14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## 27: 15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## 28: 15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## 29: 13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## 30: 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## 31: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 32: 15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb</code></pre>
<pre class="r"><code>setkeyv(dt_mtcars, c(&quot;cyl&quot;, &quot;gear&quot;))
dt_mtcars</code></pre>
<pre><code>##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb
##  1: 21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
##  2: 22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
##  3: 24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
##  4: 22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
##  5: 32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
##  6: 30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
##  7: 33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
##  8: 27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
##  9: 21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2
## 10: 26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
## 11: 30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
## 12: 21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
## 13: 18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
## 14: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 15: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 16: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 17: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
## 18: 19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
## 19: 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
## 20: 14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
## 21: 16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
## 22: 17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
## 23: 15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
## 24: 10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
## 25: 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
## 26: 14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
## 27: 15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
## 28: 15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
## 29: 13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
## 30: 19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
## 31: 15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
## 32: 15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
##      MPG cyl  disp  hp drat    wt  qsec vs am gear carb</code></pre>
<p>All tables:</p>
<pre class="r"><code>tables()</code></pre>
<pre><code>##      NAME           NROW NCOL MB
## [1,] dt_car_data       3   12  1
## [2,] dt_delay      2,962    4  1
## [3,] dt_flights  336,776   18 39
## [4,] dt_mtcars        32   11  1
##      COLS                                                                            
## [1,] cyl,mpg,disp,hp,drat,wt,qsec,vs,am,gear,carb,kpl                                
## [2,] tailnum,count,dist,delay                                                        
## [3,] year,month,day,dep_time,dep_delay,arr_time,arr_delay,carrier,tailnum,flight,orig
## [4,] MPG,cyl,disp,hp,drat,wt,qsec,vs,am,gear,carb                                    
##      KEY     
## [1,]         
## [2,]         
## [3,]         
## [4,] cyl,gear
## Total: 42MB</code></pre>
<p>Row-wise sum</p>
<pre class="r"><code>dt_mtcars[, sum(disp)]</code></pre>
<pre><code>## [1] 7383.1</code></pre>
<p>Column-wise sum</p>
<pre class="r"><code>dt_mtcars[, sum(.SD)]</code></pre>
<pre><code>## [1] 13942.2</code></pre>
<pre class="r"><code>dt_mtcars[, lapply(.SD, sum), .SDcols = names(dt_mtcars)]</code></pre>
<pre><code>##      MPG cyl   disp   hp   drat      wt   qsec vs am gear carb
## 1: 642.9 198 7383.1 4694 115.09 102.952 571.16 14 13  118   90</code></pre>
<p>Fast row-selection on keyed data</p>
<pre class="r"><code>dt_mtcars[list(6, 4)]</code></pre>
<pre><code>##     MPG cyl  disp  hp drat    wt  qsec vs am gear carb
## 1: 21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
## 2: 21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
## 3: 19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
## 4: 17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4</code></pre>
<p>Compare with</p>
<pre class="r"><code>dt_mtcars[, list(6, 4)]</code></pre>
<pre><code>##    V1 V2
## 1:  6  4</code></pre>
</div>
<div id="databases" class="section level1">
<h1>Databases</h1>
<div id="supported-databases" class="section level2">
<h2>Supported databases</h2>
</div>
</div>
<div id="wrap-up" class="section level1">
<h1>Wrap-up</h1>
</div>

<footer>
<p><small>Christine Choirat<br/>
P01 - Advanced R<br/>
Harvard T.H Chan School of Public Health <a>http://www.hsph.harvard.edu/</a>
</small></p>
</footer>

  </div>
</div>

<a href="https://github.com/p01r/p01r"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
