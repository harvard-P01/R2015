---
pagetitle: P01 - Data wrangling
---

# Scraping

<div align="center">
<img src="http://ia.media-imdb.com/images/M/MV5BMTg3NjU5MTk2Ml5BMl5BanBnXkFtZTgwNTY2MTE1MjE@._V1_SY317_CR5,0,214,317_AL_.jpg" alt="Drawing" style="height: 400px;"/>
</div>

http://www.imdb.com/title/tt0053779/


```{r}
library(rvest)
movie <- html("http://www.imdb.com/title/tt0053779/")
movie %>%
  html_nodes("#titleCast .itemprop span") %>%
  html_text()
```

## More ?

<iframe src = "https://en.wikipedia.org/wiki/List_of_highest-grossing_films" width = "100%" height = "400px";"></iframe>

```{r}
library(rvest)
d <- html("https://en.wikipedia.org/wiki/List_of_highest-grossing_films") %>%
  html_node(".wikitable") %>% 
  html_table() %>%
  head()
```

## The XML way

<iframe src = "http://energyalmanac.ca.gov/electricity/web_qfer/Heat_Rates.php" width = "100%" height = "400px";"></iframe>

```{r}
library(XML)
d <- readHTMLTable("http://energyalmanac.ca.gov/electricity/web_qfer/Heat_Rates.php", which = 1)
head(d)
```

## Downloading & Loading Data

# Manipulation grammars

## `nycflights13` dataset

-   We are going to compare 3 approaches to manipulate the same dataset:
    1.  `data.frame`
    2.  `data.table`
    3.  `dplyr` table (extension of `data.frame`, `data.table`-aware)

-   There is no "best" approach and these data classes can be combined.

## Load data

-   Pre-packaged dataset:

```{r}
library(nycflights13)
head(flights)
```

## Create datasets

```{r}
library(dplyr)
library(data.table)

## Default is dplyr table
dp_flights <- flights
## Explicit conversion
## dp_flights <- tbl_df(flights)
## Base data frame
df_flights <- data.frame(flights)
## Data table
dt_flights <- data.table(flights)
```

## Pretty-print

```{r}
head(df_flights)
```

```{r}
dp_flights
dt_flights
```

## Filter rows

```{r}
head(df_flights[df_flights$month == 1 & df_flights$day == 1, ])
```

```{r}
head(df_flights[1:10, ])
```

```{r eval=FALSE}
head(df_flights[1:10, ])
slice(dp_flights, 1:10)
dt_flights[1:10]
```

## Arrange rows

```{r}
head(with(df_flights, df_flights[order(year, month, day), ]))
```

```{r eval=FALSE}
head(with(df_flights, df_flights[order(year, month, day), ]))
arrange(dp_flights, year, month, day)
dt_flights[order(year, month, day)]
```

```{r}
head(with(df_flights, df_flights[order(-arr_delay), ]))
```

```{r eval=FALSE}
head(with(df_flights, df_flights[order(-arr_delay), ]))
arrange(flights, desc(arr_delay))
dt_flights[order(-arr_delay)]
```

## Performance (TBC)

```{r}
system.time(with(df_flights, df_flights[order(-arr_delay), ]))
system.time(arrange(flights, desc(arr_delay)))
system.time(dt_flights[order(-arr_delay)])
```

## Select columns

```{r}
head(select(df_flights, year, month, day))
```

```{r eval=FALSE}
head(select(df_flights, year, month, day))
select(dp_flights, year, month, day)
dt_flights[, .(year, month, day)]
dt_flights[, list(year, month, day)]
```

```{r}
## Not as expected!
dt_flights[, c("year", "month", "day")]
dt_flights[, c("year", "month", "day"), with = FALSE]
```

## Extract distinct (unique) rows

```{r}
head(unique(df_flights, by = "tailnum"))
```

```{r eval=FALSE}
head(unique(df_flights, by = "tailnum"))
distinct(select(flights, tailnum))
unique(dt_flights, by = "tailnum")
```

## Add new columns

```{r}
## Copy
df_flights$gain <-
  df_flights$arr_delay - df_flights$dep_delay
df_flights$speed <-
  df_flights$distance / df_flights$air_time * 60
```

```{r}
## Copy
mutate(dp_flights,
       gain = arr_delay - dep_delay,
       speed = distance / air_time * 60)
## In-place
dt_flights[, gain := arr_delay - dep_delay]
dt_flights[, speed := arr_delay - dep_delay,
           distance / air_time * 60]
```

## Create new dataset from columns

```{r}
df_flights_2 <- data.frame(gain = df_flights$arr_delay - df_flights$dep_delay,
                           speed = df_flights$distance / df_flights$air_time * 60)
head(df_flights_2)
```

```{r}
transmute(dp_flights,
          gain = arr_delay - dep_delay,
          speed = distance / air_time * 60)

dt_flights[, .(gain = arr_delay - dep_delay,
               gain_per_hour = gain / (air_time / 60))]
dt_flights[, list(gain = arr_delay - dep_delay,
                  gain_per_hour = gain / (air_time / 60))]
```

## Summarize values

```{r}
mean(df_flights$dep_delay, na.rm = TRUE)
```

```{r eval=FALSE}
summarise(dp_flights,
          delay = mean(dep_delay, na.rm = TRUE))

dt_flights[, .(delay = mean(dep_delay, na.rm = TRUE))]
dt_flights[, list(delay = mean(dep_delay, na.rm = TRUE))]
```

## Randomly sample rows

```{r}
set.seed(1234)
head(df_flights[sample(nrow(df_flights), 10), ])
sample_n(dp_flights, 10)
dt_flights[sample(.N, 10)]
```

```{r}
head(df_flights[sample(round(.N * 0.01)), ])
sample_frac(dp_flights, 0.01)
dt_flights[sample(round(.N * 0.01))]
```

## Grouped operations

```{r}
by_tailnum <- group_by(dp_flights, tailnum)

dp_delay <- summarise(by_tailnum,
                      count = n(),
                      dist = mean(distance, na.rm = TRUE),
                      delay = mean(arr_delay, na.rm = TRUE))
dp_delay <- filter(dp_delay, count > 20, dist < 2000)
dp_delay
```

```{r}
dt_delay <-
  dt_flights[, .(count = .N,
                 dist = mean(distance, na.rm = TRUE),
                 delay = mean(arr_delay, na.rm = TRUE)),
             by = list(tailnum)][count > 20 &  dist < 2000]
dt_delay
```

## Chaining

```{r}
a1 <- group_by(flights, year, month, day)
a2 <- select(a1, arr_delay, dep_delay)
a3 <- summarise(a2,
                arr = mean(arr_delay, na.rm = TRUE),
                dep = mean(dep_delay, na.rm = TRUE))
a4 <- filter(a3, arr > 30 | dep > 30)
a4
```

```{r}
filter(
  summarise(
    select(
      group_by(flights, year, month, day),
      arr_delay, dep_delay
      ),
    arr = mean(arr_delay, na.rm = TRUE),
    dep = mean(dep_delay, na.rm = TRUE)
    ),
  arr > 30 | dep > 30
  )
```

## Ceci n'est pas une pipe (Magritte)

\centering
![img](images/MagrittePipe.jpg)

## Ceci n'est pas un pipe (`magrittr`)

\centering
![img](images/magrittr.jpg)

## Chaining

```{r}
flights %>%
  group_by(year, month, day) %>%
  select(arr_delay, dep_delay) %>%
  summarise(
    arr = mean(arr_delay, na.rm = TRUE),
    dep = mean(dep_delay, na.rm = TRUE)
    ) %>%
  filter(arr > 30 | dep > 30)
```

```{r}
dt_delay <- dt_flights[, .(count = .N,
                           dist = mean(distance, na.rm = TRUE),
                           delay = mean(arr_delay, na.rm = TRUE)),
                       by = list(tailnum)][count > 20 &  dist < 2000]
dt_delay
```

## Pipes???

`magrittr` [vignette](https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html):

> We start with a value, here mtcars (a data.frame). Based on this, we
> first extract a subset,  then we aggregate the information based on
> the number of cylinders,  and then we transform the dataset by adding
> a variable for kilometers  per liter as supplement to miles per
> gallon. Finally  we print the result before assigning it. Note how the
> code is  arranged in the logical order of how you think about the
> task:  data->transform->aggregate, which is also the same order as the
> code will execute. It's like a recipe â€“ easy to read, easy to follow!

```{r}
library(magrittr)
car_data <- 
  mtcars %>%
  subset(hp > 100) %>%
  aggregate(. ~ cyl, data = ., FUN = . %>% mean %>% round(2)) %>%
  transform(kpl = mpg %>% multiply_by(0.4251)) %>%
  print
```

```{r}
dt_mtcars <- data.table(mtcars)
dt_car_data <- dt_mtcars[hp > 100][, lapply(.SD, function(x) round(mean(x), 2)),
                                   by = "cyl"][, kpl := mpg*0.4251]
dt_car_data
```

# Not always as expected...

```{r}
dt_mtcars <- data.table(mtcars)
names(dt_mtcars)
names(dt_mtcars)[1] <- "MPG"
```

Let's try again:

```{r}
dt_mtcars <- data.table(mtcars)
names(dt_mtcars)
# same:
setnames(dt_mtcars, "mpg", "MPG")
setnames(dt_mtcars, names(dt_mtcars)[1], "MPG")
```

No:

```{r}
f <- function(dt, selected_variables = c("gear", "carb")) {
  return(dt[, selected_variables])
}

f(dt_mtcars)
```

Almost:

```{r}
f <- function(dt, selected_variables = c("gear", "carb")) {
  return(dt[, get(selected_variables)])
}

f(dt_mtcars)
```

Yes:

```{r}
f <- function(dt, selected_variables = c("gear", "carb")) {
  return(dt[get(selected_variables)])
}

f(dt_mtcars)
```

# `data.table` tricks

- very fast `fread`
- very fast `merge`

Number of elements in a group:

```{r}
dt_mtcars[, .N, by = "cyl"]
```

All columns:

```{r}
dt_mtcars[, .SD]
```

Using keys:

```{r}
setkey(dt_mtcars, "cyl")
dt_mtcars
setkeyv(dt_mtcars, c("cyl", "gear"))
dt_mtcars
```

All tables:

```{r}
tables()
```

Row-wise sum

```{r}
dt_mtcars[, sum(disp)]
```

Column-wise sum

```{r}
dt_mtcars[, sum(.SD)]
dt_mtcars[, lapply(.SD, sum), .SDcols = names(dt_mtcars)]
```

Fast row-selection on keyed data

```{r}
dt_mtcars[list(6, 4)]
```

Compare with

```{r}
dt_mtcars[, list(6, 4)]
```

# Wrap-up
